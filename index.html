<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Einkaufsliste mit automatischer Preisberechnung">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Meine Einkaufsliste</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body.dark {
      background: #0f172a;
    }
    .dark .bg-white { background: #1e293b; }
    .dark .bg-gray-50 { background: #334155; }
    .dark .bg-gray-100 { background: #475569; }
    .dark .bg-blue-50 { background: #1e3a5f; }
    .dark .bg-green-50 { background: #1e3a2f; }
    .dark .text-gray-800 { color: #f1f5f9; }
    .dark .text-gray-700 { color: #e2e8f0; }
    .dark .text-gray-600 { color: #cbd5e1; }
    .dark .text-gray-500 { color: #94a3b8; }
    .dark .text-gray-400 { color: #64748b; }
    .dark .border-gray-200 { border-color: #475569; }
    .dark .border-gray-100 { border-color: #334155; }
    .dark .border-blue-300 { border-color: #3b82f6; }
    .dark .from-blue-50 { --tw-gradient-from: #0f172a; }
    .dark .to-indigo-100 { --tw-gradient-to: #1e293b; }

```
/* Responsive Fixes */
@media (max-width: 640px) {
  .compact-mobile { padding: 0.75rem; }
  .text-responsive { font-size: 0.9rem; }
}
```

  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    let items = [];
    let editingId = null;
    let darkMode = localStorage.getItem('darkMode') === 'true';

    const saved = localStorage.getItem('shoppingList');
    if (saved) {
      try {
        items = JSON.parse(saved);
      } catch (e) {
        console.error('Fehler beim Laden:', e);
      }
    }

    function toggleDarkMode() {
      darkMode = !darkMode;
      localStorage.setItem('darkMode', darkMode);
      applyDarkMode();
    }

    function applyDarkMode() {
      if (darkMode) {
        document.body.classList.add('dark');
      } else {
        document.body.classList.remove('dark');
      }
    }

    function saveItems() {
      localStorage.setItem('shoppingList', JSON.stringify(items));
      showSaveNotification();
    }

    function showSaveNotification() {
      const notification = document.getElementById('saveNotification');
      if (notification) {
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.add('hidden'), 2000);
      }
    }

    function calculateTotal(quantity, unitPrice) {
      const qty = parseFloat(quantity) || 1;
      const price = parseFloat(unitPrice) || 0;
      return qty * price;
    }

    function updateLiveCalculation() {
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');
      const resultDiv = document.getElementById('liveResult');
      
      if (quantityInput && priceInput && resultDiv) {
        const total = calculateTotal(quantityInput.value, priceInput.value);
        resultDiv.innerHTML = total > 0 ? `
          <div class="bg-green-50 px-3 py-1.5 rounded-lg border-2 border-green-200">
            <div class="text-xs text-green-600 font-medium">â‚¬${total.toFixed(2)}</div>
          </div>
        ` : '';
      }
    }

    function addItem() {
      const itemInput = document.getElementById('itemInput');
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');
      
      const text = itemInput.value.trim();
      if (!text) return;
      
      const qty = parseFloat(quantityInput.value) || 1;
      const unitPrice = parseFloat(priceInput.value) || 0;
      
      items.push({
        id: Date.now(),
        text: text,
        quantity: qty,
        unitPrice: unitPrice,
        totalPrice: calculateTotal(qty, unitPrice),
        completed: false
      });
      
      itemInput.value = '';
      quantityInput.value = '1';
      priceInput.value = '';
      
      saveItems();
      renderList();
      updateSummary();
      updateLiveCalculation();
    }

    function toggleItem(id) {
      items = items.map(item => 
        item.id === id ? { ...item, completed: !item.completed } : item
      );
      saveItems();
      renderList();
      updateSummary();
    }

    function deleteItem(id) {
      items = items.filter(item => item.id !== id);
      saveItems();
      renderList();
      updateSummary();
    }

    function startEdit(id) {
      editingId = id;
      renderList();
    }

    function saveEdit(id) {
      const nameInput = document.getElementById(`edit-name-${id}`);
      const qtyInput = document.getElementById(`edit-qty-${id}`);
      const priceInput = document.getElementById(`edit-price-${id}`);
      
      if (nameInput && qtyInput && priceInput) {
        const qty = parseFloat(qtyInput.value) || 1;
        const unitPrice = parseFloat(priceInput.value) || 0;
        
        items = items.map(item => 
          item.id === id ? {
            ...item,
            text: nameInput.value,
            quantity: qty,
            unitPrice: unitPrice,
            totalPrice: calculateTotal(qty, unitPrice)
          } : item
        );
        
        editingId = null;
        saveItems();
        renderList();
        updateSummary();
      }
    }

    function cancelEdit() {
      editingId = null;
      renderList();
    }

    function clearCompleted() {
      items = items.filter(item => !item.completed);
      saveItems();
      renderList();
      updateSummary();
    }

    function updateSummary() {
      const completedCount = items.filter(item => item.completed).length;
      const totalCount = items.length;
      const totalPrice = items.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const completedPrice = items.filter(item => item.completed).reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const remainingPrice = totalPrice - completedPrice;

      const countEl = document.getElementById('itemCount');
      const totalPriceEl = document.getElementById('totalPrice');
      const remainingPriceEl = document.getElementById('remainingPrice');
      const shareBtn = document.getElementById('shareBtn');
      const qrBtn = document.getElementById('qrBtn');

      if (countEl) countEl.textContent = `${completedCount} von ${totalCount} erledigt`;
      if (totalPriceEl) totalPriceEl.textContent = `â‚¬${totalPrice.toFixed(2)}`;
      if (remainingPriceEl) {
        remainingPriceEl.innerHTML = completedPrice > 0 ? `<p class="text-xs sm:text-sm text-gray-500">Noch: â‚¬${remainingPrice.toFixed(2)}</p>` : '';
      }
      if (shareBtn) shareBtn.disabled = items.length === 0;
      if (qrBtn) qrBtn.disabled = items.length === 0;
    }

    function renderList() {
      const listContainer = document.getElementById('itemList');
      const completedCount = items.filter(item => item.completed).length;
      
      if (items.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center py-8">
            <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400">
                <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
              </svg>
            </div>
            <p class="text-gray-500">Deine Liste ist leer</p>
          </div>
        `;
      } else {
        listContainer.innerHTML = `
          <div class="space-y-2 max-h-96 overflow-y-auto">
            ${items.map(item => {
              if (editingId === item.id) {
                return `
                  <div class="p-3 bg-blue-50 rounded-lg border-2 border-blue-300">
                    <input type="text" id="edit-name-${item.id}" value="${item.text}" 
                      class="w-full px-2 py-1.5 border-2 border-blue-300 rounded-lg mb-2 text-sm sm:text-base">
                    <div class="flex gap-2 mb-2">
                      <input type="number" id="edit-qty-${item.id}" value="${item.quantity}" step="0.1" 
                        class="flex-1 px-2 py-1.5 border-2 border-blue-300 rounded-lg text-sm sm:text-base">
                      <input type="number" id="edit-price-${item.id}" value="${item.unitPrice}" step="0.01" 
                        class="flex-1 px-2 py-1.5 border-2 border-blue-300 rounded-lg text-sm sm:text-base" placeholder="Preis">
                    </div>
                    <div class="flex gap-2">
                      <button onclick="saveEdit(${item.id})" class="flex-1 bg-green-500 text-white px-3 py-1.5 rounded-lg font-semibold text-sm">
                        Speichern
                      </button>
                      <button onclick="cancelEdit()" class="flex-1 bg-gray-400 text-white px-3 py-1.5 rounded-lg font-semibold text-sm">
                        Abbrechen
                      </button>
                    </div>
                  </div>
                `;
              } else {
                return `
                  <div class="flex items-center gap-2 p-2.5 sm:p-3 bg-gray-50 rounded-lg">
                    <button onclick="toggleItem(${item.id})" 
                      class="w-5 h-5 sm:w-6 sm:h-6 rounded-lg border-2 flex items-center justify-center flex-shrink-0 ${item.completed ? 'bg-green-500 border-green-500' : 'border-gray-300'}">
                      ${item.completed ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                    </button>
                    <div class="flex-1 min-w-0">
                      <span class="text-sm sm:text-base font-medium block truncate ${item.completed ? 'line-through text-gray-400' : 'text-gray-700'}">
                        ${item.text} ${item.quantity > 1 ? `<span class="text-xs text-gray-500">(${item.quantity}x)</span>` : ''}
                      </span>
                      ${item.unitPrice > 0 ? `
                        <div class="text-xs mt-0.5 ${item.completed ? 'text-gray-400' : 'text-gray-500'}">
                          ${item.quantity > 1 ? `${item.quantity}x Ã  â‚¬${item.unitPrice.toFixed(2)}` : `â‚¬${item.unitPrice.toFixed(2)}`}
                        </div>
                      ` : ''}
                      ${item.totalPrice > 0 ? `
                        <div class="text-xs sm:text-sm font-bold mt-0.5 ${item.completed ? 'text-gray-400' : 'text-indigo-600'}">
                          â‚¬${item.totalPrice.toFixed(2)}
                        </div>
                      ` : ''}
                    </div>
                    <button onclick="startEdit(${item.id})" class="text-blue-500 hover:bg-blue-50 p-1.5 rounded-lg flex-shrink-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                      </svg>
                    </button>
                    <button onclick="deleteItem(${item.id})" class="text-red-500 hover:bg-red-50 p-1.5 rounded-lg flex-shrink-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      </svg>
                    </button>
                  </div>
                `;
              }
            }).join('')}
          </div>
          ${completedCount > 0 ? `
            <div class="mt-3 pt-3 border-t border-gray-200">
              <button onclick="clearCompleted()" class="text-red-500 hover:text-red-600 font-medium text-xs sm:text-sm">
                Erledigte lÃ¶schen (${completedCount})
              </button>
            </div>
          ` : ''}
        `;
      }
    }

    function shareList() {
      const shareBtn = document.getElementById('shareBtn');
      shareBtn.textContent = 'LÃ¤dt...';
      shareBtn.disabled = true;
      
      const listText = items
        .filter(item => !item.completed)
        .map(item => {
          let line = `â€¢ ${item.text}`;
          if (item.quantity > 1) line += ` (${item.quantity}x)`;
          if (item.totalPrice > 0) line += ` - â‚¬${item.totalPrice.toFixed(2)}`;
          return line;
        })
        .join('\n');
      
      const totalPrice = items.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const fullText = `ðŸ›’ Einkaufsliste\n\n${listText}\n\nGesamt: â‚¬${totalPrice.toFixed(2)}`;

      if (navigator.share) {
        navigator.share({ title: 'Meine Einkaufsliste', text: fullText })
          .catch(err => {
            if (err.name !== 'AbortError') {
              fallbackCopy(fullText);
            }
          })
          .finally(() => {
            shareBtn.textContent = 'Liste teilen';
            shareBtn.disabled = false;
          });
      } else {
        fallbackCopy(fullText);
        shareBtn.textContent = 'Liste teilen';
        shareBtn.disabled = false;
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        alert('âœ… Liste kopiert!');
      } catch (err) {
        alert('Liste:\n\n' + text);
      }
      document.body.removeChild(textArea);
    }

    function generateQR() {
      const listText = items
        .filter(item => !item.completed)
        .map(item => {
          let line = `â€¢ ${item.text}`;
          if (item.quantity > 1) line += ` (${item.quantity}x)`;
          if (item.totalPrice > 0) line += ` - â‚¬${item.totalPrice.toFixed(2)}`;
          return line;
        })
        .join('\n');
      
      const totalPrice = items.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const fullText = `ðŸ›’ Einkaufsliste\n\n${listText}\n\nGesamt: â‚¬${totalPrice.toFixed(2)}`;

      const modal = document.getElementById('qrModal');
      const qrContainer = document.getElementById('qrcode');
      
      qrContainer.innerHTML = '';
      
      try {
        new QRCode(qrContainer, {
          text: fullText,
          width: 200,
          height: 200,
          colorDark: darkMode ? "#ffffff" : "#000000",
          colorLight: darkMode ? "#1e293b" : "#ffffff",
          correctLevel: QRCode.CorrectLevel.L
        });
        modal.classList.remove('hidden');
      } catch (err) {
        alert('QR-Code konnte nicht erstellt werden');
        console.error('QR Error:', err);
      }
    }

    function closeQRModal() {
      document.getElementById('qrModal').classList.add('hidden');
    }

    function initApp() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2 sm:p-4">
          <div class="max-w-2xl mx-auto">
            <div id="saveNotification" class="hidden fixed top-2 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm">
              <span class="font-semibold">Gespeichert!</span>
            </div>

            <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this) closeQRModal()">
              <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-sm w-full p-4">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">QR-Code</h3>
                  <button onclick="closeQRModal()" class="text-gray-400 hover:text-gray-600">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-300 mb-3">
                  Scanne mit der Handy-Kamera
                </p>
                <div class="flex justify-center bg-white p-3 rounded-xl">
                  <div id="qrcode"></div>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-t-2xl shadow-lg p-3 sm:p-5">
              <div class="flex items-start justify-between mb-3 gap-2">
                <div class="flex items-center gap-2 flex-1 min-w-0">
                  <div class="bg-indigo-500 p-2 rounded-xl text-white flex-shrink-0">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                    </svg>
                  </div>
                  <div class="min-w-0">
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800 truncate">Einkaufsliste</h1>
                    <p class="text-xs sm:text-sm text-gray-500" id="itemCount">0 von 0 erledigt</p>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <button onclick="toggleDarkMode()" class="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600 dark:text-gray-300">
                      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                  </button>
                  <div class="text-right">
                    <div class="text-lg sm:text-xl font-bold text-indigo-600" id="totalPrice">â‚¬0.00</div>
                    <div id="remainingPrice"></div>
                  </div>
                </div>
              </div>

              <div class="pt-3 border-t border-gray-200">
                <div class="flex gap-2">
                  <button id="shareBtn" onclick="shareList()" disabled
                    class="flex-1 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white px-3 py-2 rounded-lg font-semibold text-sm">
                    Teilen
                  </button>
                  <button onclick="generateQR()" disabled id="qrBtn"
                    class="flex-1 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-300 text-white px-3 py-2 rounded-lg font-semibold text-sm">
                    QR-Code
                  </button>
                </div>
              </div>
            </div>

            <div class="bg-white shadow-lg p-3 border-t border-gray-100">
              <input type="text" id="itemInput" placeholder="Artikel..." 
                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none text-sm sm:text-base mb-2">
              
              <div class="flex gap-2 mb-2 items-end">
                <div class="flex-1">
                  <label class="text-xs text-gray-500 mb-1 block">Anzahl</label>
                  <input type="number" id="quantityInput" value="1" step="0.1" min="0.1"
                    class="w-full px-2 py-1.5 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none text-sm">
                </div>
                <div class="flex-1">
                  <label class="text-xs text-gray-500 mb-1 block">Preis â‚¬</label>
                  <input type="number" id="priceInput" step="0.01" min="0" placeholder="0.00"
                    class="w-full px-2 py-1.5 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none text-sm">
                </div>
                <div id="liveResult"></div>
              </div>
              
              <button onclick="addItem()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                HinzufÃ¼gen
              </button>
            </div>

            <div class="bg-white rounded-b-2xl shadow-lg p-3" id="itemList"></div>
          </div>
        </div>
      `;

      const itemInput = document.getElementById('itemInput');
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');

      itemInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addItem();
      });

      quantityInput.addEventListener('input', updateLiveCalculation);
      priceInput.addEventListener('input', updateLiveCalculation);

      renderList();
      updateSummary();
    }

    window.addItem = addItem;
    window.toggleItem = toggleItem;
    window.deleteItem = deleteItem;
    window.startEdit = startEdit;
    window.saveEdit = saveEdit;
    window.cancelEdit = cancelEdit;
    window.clearCompleted = clearCompleted;
    window.shareList = shareList;
    window.toggleDarkMode = toggleDarkMode;
    window.generateQR = generateQR;
    window.closeQRModal = closeQRModal;

    applyDarkMode();
    initApp();
  </script>

</body>
</html>
