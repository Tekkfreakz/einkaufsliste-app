<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Einkaufsliste mit automatischer Preisberechnung">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Meine Einkaufsliste</title>

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%236366f1' width='100' height='100' rx='20'/%3E%3Cpath fill='white' d='M25 25h8l5 25h35l5-15H35l-2-8h45l-7 28H33z'/%3E%3Ccircle fill='white' cx='40' cy='75' r='5'/%3E%3Ccircle fill='white' cx='68' cy='75' r='5'/%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%236366f1' width='100' height='100' rx='20'/%3E%3Cpath fill='white' d='M25 25h8l5 25h35l5-15H35l-2-8h45l-7 28H33z'/%3E%3Ccircle fill='white' cx='40' cy='75' r='5'/%3E%3Ccircle fill='white' cx='68' cy='75' r='5'/%3E%3C/svg%3E">

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    body.dark {
      background: #0f172a;
    }
    .dark .bg-white { background: #1e293b; }
    .dark .bg-gray-50 { background: #334155; }
    .dark .bg-gray-100 { background: #475569; }
    .dark .bg-blue-50 { background: #1e3a5f; }
    .dark .bg-green-50 { background: #1e3a2f; }
    .dark .text-gray-800 { color: #f1f5f9; }
    .dark .text-gray-700 { color: #e2e8f0; }
    .dark .text-gray-600 { color: #cbd5e1; }
    .dark .text-gray-500 { color: #94a3b8; }
    .dark .text-gray-400 { color: #64748b; }
    .dark .border-gray-200 { border-color: #475569; }
    .dark .border-gray-100 { border-color: #334155; }
    .dark .border-blue-300 { border-color: #3b82f6; }
    .dark .from-blue-50 { --tw-gradient-from: #0f172a; }
    .dark .to-indigo-100 { --tw-gradient-to: #1e293b; }
    
    @media (max-width: 640px) {
      .compact-mobile { padding: 0.75rem; }
      .text-responsive { font-size: 0.9rem; }
    }

    #reader {
      border-radius: 12px;
      overflow: hidden;
    }
    
    #reader video {
      border-radius: 12px;
    }

    .sync-indicator {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
  </style>

</head>
<body>
  <div id="app"></div>

  <script type="module">
    let items = [];
    let editingId = null;
    let darkMode = localStorage.getItem('darkMode') === 'true';
    let html5QrCode = null;
    let isScanning = false;
    
    // P2P Variablen
    let peer = null;
    let connections = [];
    let myPeerId = localStorage.getItem('myPeerId') || null;
    let isHost = false;
    let connectedPeerId = localStorage.getItem('connectedPeerId') || null;

    const saved = localStorage.getItem('shoppingList');
    if (saved) {
      try {
        items = JSON.parse(saved);
      } catch (e) {
        console.error('Fehler beim Laden:', e);
      }
    }

    // PeerJS initialisieren
    function initPeer() {
      if (peer) return;
      
      peer = new Peer(myPeerId, {
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        }
      });

      peer.on('open', (id) => {
        myPeerId = id;
        localStorage.setItem('myPeerId', id);
        console.log('Meine Peer ID:', id);
        
        // Wenn wir vorher verbunden waren, versuche wieder zu verbinden
        if (connectedPeerId && !isHost) {
          connectToPeer(connectedPeerId);
        }
      });

      peer.on('connection', (conn) => {
        handleConnection(conn);
      });

      peer.on('error', (err) => {
        console.error('Peer Fehler:', err);
        updateSyncStatus(false);
      });
    }

    function handleConnection(conn, isOutgoing = false) {
      connections.push(conn);
      
      conn.on('open', () => {
        updateSyncStatus(true);
        // Nur der Host sendet die Liste beim Verbindungsaufbau
        if (isHost && !isOutgoing) {
          conn.send({ type: 'sync', items: items });
        }
        // Gast fordert Liste vom Host an
        if (isOutgoing) {
          conn.send({ type: 'request_sync' });
        }
      });

      conn.on('data', (data) => {
        if (data.type === 'sync') {
          // Empfange Liste vom Host und Ã¼berschreibe eigene
          items = data.items;
          saveItemsLocally();
          renderList();
          updateSummary();
          showNotification('âœ… Liste synchronisiert!');
        } else if (data.type === 'request_sync') {
          // Host sendet Liste auf Anfrage
          if (isHost) {
            conn.send({ type: 'sync', items: items });
          }
        } else if (data.type === 'update') {
          // Live-Updates wÃ¤hrend der Verbindung
          items = data.items;
          saveItemsLocally();
          renderList();
          updateSummary();
        }
      });

      conn.on('close', () => {
        connections = connections.filter(c => c !== conn);
        if (connections.length === 0) {
          updateSyncStatus(false);
        }
      });
    }

    function connectToPeer(peerId) {
      if (!peer) {
        initPeer();
        setTimeout(() => connectToPeer(peerId), 1000);
        return;
      }

      connectedPeerId = peerId;
      localStorage.setItem('connectedPeerId', peerId);
      
      const conn = peer.connect(peerId);
      handleConnection(conn, true); // true = ausgehende Verbindung (Gast)
    }

    function broadcastUpdate() {
      connections.forEach(conn => {
        if (conn.open) {
          conn.send({ type: 'update', items: items });
        }
      });
    }

    function becomeHost() {
      if (!peer) {
        initPeer();
      }
      isHost = true;
      updateSyncStatus(true);
    }

    function disconnectFromPeers() {
      connections.forEach(conn => conn.close());
      connections = [];
      connectedPeerId = null;
      localStorage.removeItem('connectedPeerId');
      isHost = false;
      updateSyncStatus(false);
    }

    function updateSyncStatus(online) {
      const indicator = document.getElementById('syncIndicator');
      if (!indicator) return;
      
      if (online && (connections.length > 0 || isHost)) {
        const count = connections.length;
        indicator.innerHTML = `
          <div class="flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
            <div class="w-2 h-2 bg-green-500 rounded-full sync-indicator"></div>
            <span class="font-medium">Live${count > 0 ? ' (' + count + ')' : ''}</span>
          </div>
        `;
      } else {
        indicator.innerHTML = `
          <div class="flex items-center gap-1 text-xs text-gray-400">
            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
            <span>Offline</span>
          </div>
        `;
      }
    }

    function toggleDarkMode() {
      darkMode = !darkMode;
      localStorage.setItem('darkMode', darkMode);
      applyDarkMode();
    }

    function applyDarkMode() {
      if (darkMode) {
        document.body.classList.add('dark');
      } else {
        document.body.classList.remove('dark');
      }
    }

    function saveItemsLocally() {
      localStorage.setItem('shoppingList', JSON.stringify(items));
    }

    function saveItems() {
      saveItemsLocally();
      broadcastUpdate();
      showSaveNotification();
    }

    function showSaveNotification() {
      const notification = document.getElementById('saveNotification');
      if (notification) {
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.add('hidden'), 2000);
      }
    }

    function calculateTotal(quantity, unitPrice) {
      const qty = parseFloat(quantity) || 1;
      const price = parseFloat(unitPrice) || 0;
      return qty * price;
    }

    function updateLiveCalculation() {
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');
      const resultDiv = document.getElementById('liveResult');
      
      if (quantityInput && priceInput && resultDiv) {
        const total = calculateTotal(quantityInput.value, priceInput.value);
        resultDiv.innerHTML = total > 0 ? `
          <div class="bg-green-50 px-3 py-1.5 rounded-lg border-2 border-green-200">
            <div class="text-xs text-green-600 font-medium">â‚¬${total.toFixed(2)}</div>
          </div>
        ` : '';
      }
    }

    function addItem() {
      const itemInput = document.getElementById('itemInput');
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');
      
      const text = itemInput.value.trim();
      if (!text) return;
      
      const qty = parseFloat(quantityInput.value) || 1;
      const unitPrice = parseFloat(priceInput.value) || 0;
      
      items.push({
        id: Date.now(),
        text: text,
        quantity: qty,
        unitPrice: unitPrice,
        totalPrice: calculateTotal(qty, unitPrice),
        completed: false
      });
      
      itemInput.value = '';
      quantityInput.value = '1';
      priceInput.value = '';
      
      saveItems();
      renderList();
      updateSummary();
      updateLiveCalculation();
    }

    function toggleItem(id) {
      items = items.map(item => 
        item.id === id ? { ...item, completed: !item.completed } : item
      );
      saveItems();
      renderList();
      updateSummary();
    }

    function deleteItem(id) {
      items = items.filter(item => item.id !== id);
      saveItems();
      renderList();
      updateSummary();
    }

    function startEdit(id) {
      editingId = id;
      renderList();
    }

    function saveEdit(id) {
      const nameInput = document.getElementById(`edit-name-${id}`);
      const qtyInput = document.getElementById(`edit-qty-${id}`);
      const priceInput = document.getElementById(`edit-price-${id}`);
      
      if (nameInput && qtyInput && priceInput) {
        const qty = parseFloat(qtyInput.value) || 1;
        const unitPrice = parseFloat(priceInput.value) || 0;
        
        items = items.map(item => 
          item.id === id ? {
            ...item,
            text: nameInput.value,
            quantity: qty,
            unitPrice: unitPrice,
            totalPrice: calculateTotal(qty, unitPrice)
          } : item
        );
        
        editingId = null;
        saveItems();
        renderList();
        updateSummary();
      }
    }

    function cancelEdit() {
      editingId = null;
      renderList();
    }

    function clearCompleted() {
      items = items.filter(item => !item.completed);
      saveItems();
      renderList();
      updateSummary();
    }

    function updateSummary() {
      const completedCount = items.filter(item => item.completed).length;
      const totalCount = items.length;
      const totalPrice = items.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const completedPrice = items.filter(item => item.completed).reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const remainingPrice = totalPrice - completedPrice;

      const countEl = document.getElementById('itemCount');
      const totalPriceEl = document.getElementById('totalPrice');
      const remainingPriceEl = document.getElementById('remainingPrice');
      const shareBtn = document.getElementById('shareBtn');
      const qrBtn = document.getElementById('qrBtn');

      if (countEl) countEl.textContent = `${completedCount} von ${totalCount} erledigt`;
      if (totalPriceEl) totalPriceEl.textContent = `â‚¬${totalPrice.toFixed(2)}`;
      if (remainingPriceEl) {
        remainingPriceEl.innerHTML = completedPrice > 0 ? `<p class="text-xs sm:text-sm text-gray-500">Noch: â‚¬${remainingPrice.toFixed(2)}</p>` : '';
      }
      if (shareBtn) shareBtn.disabled = items.length === 0;
      if (qrBtn) qrBtn.disabled = items.length === 0;
    }

    function renderList() {
      const listContainer = document.getElementById('itemList');
      const completedCount = items.filter(item => item.completed).length;
      
      if (items.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center py-8">
            <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400">
                <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
              </svg>
            </div>
            <p class="text-gray-500">Deine Liste ist leer</p>
          </div>
        `;
      } else {
        listContainer.innerHTML = `
          <div class="space-y-2 max-h-96 overflow-y-auto">
            ${items.map(item => {
              if (editingId === item.id) {
                return `
                  <div class="p-3 bg-blue-50 rounded-lg border-2 border-blue-300">
                    <input type="text" id="edit-name-${item.id}" value="${item.text}" 
                      class="w-full px-2 py-1.5 border-2 border-blue-300 rounded-lg mb-2 text-sm sm:text-base">
                    <div class="flex gap-2 mb-2">
                      <input type="number" id="edit-qty-${item.id}" value="${item.quantity}" step="0.1" 
                        class="flex-1 px-2 py-1.5 border-2 border-blue-300 rounded-lg text-sm sm:text-base">
                      <input type="number" id="edit-price-${item.id}" value="${item.unitPrice}" step="0.01" 
                        class="flex-1 px-2 py-1.5 border-2 border-blue-300 rounded-lg text-sm sm:text-base" placeholder="Preis">
                    </div>
                    <div class="flex gap-2">
                      <button onclick="saveEdit(${item.id})" class="flex-1 bg-green-500 text-white px-3 py-1.5 rounded-lg font-semibold text-sm">
                        Speichern
                      </button>
                      <button onclick="cancelEdit()" class="flex-1 bg-gray-400 text-white px-3 py-1.5 rounded-lg font-semibold text-sm">
                        Abbrechen
                      </button>
                    </div>
                  </div>
                `;
              } else {
                return `
                  <div class="flex items-center gap-2 p-2.5 sm:p-3 bg-gray-50 rounded-lg">
                    <button onclick="toggleItem(${item.id})" 
                      class="w-5 h-5 sm:w-6 sm:h-6 rounded-lg border-2 flex items-center justify-center flex-shrink-0 ${item.completed ? 'bg-green-500 border-green-500' : 'border-gray-300'}">
                      ${item.completed ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                    </button>
                    <div class="flex-1 min-w-0">
                      <span class="text-sm sm:text-base font-medium block truncate ${item.completed ? 'line-through text-gray-400' : 'text-gray-700'}">
                        ${item.text} ${item.quantity > 1 ? `<span class="text-xs text-gray-500">(${item.quantity}x)</span>` : ''}
                      </span>
                      ${item.unitPrice > 0 ? `
                        <div class="text-xs mt-0.5 ${item.completed ? 'text-gray-400' : 'text-gray-500'}">
                          ${item.quantity > 1 ? `${item.quantity}x Ã  â‚¬${item.unitPrice.toFixed(2)}` : `â‚¬${item.unitPrice.toFixed(2)}`}
                        </div>
                      ` : ''}
                      ${item.totalPrice > 0 ? `
                        <div class="text-xs sm:text-sm font-bold mt-0.5 ${item.completed ? 'text-gray-400' : 'text-indigo-600'}">
                          â‚¬${item.totalPrice.toFixed(2)}
                        </div>
                      ` : ''}
                    </div>
                    <button onclick="startEdit(${item.id})" class="text-blue-500 hover:bg-blue-50 p-1.5 rounded-lg flex-shrink-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                      </svg>
                    </button>
                    <button onclick="deleteItem(${item.id})" class="text-red-500 hover:bg-red-50 p-1.5 rounded-lg flex-shrink-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      </svg>
                    </button>
                  </div>
                `;
              }
            }).join('')}
          </div>
          ${completedCount > 0 ? `
            <div class="mt-3 pt-3 border-t border-gray-200">
              <button onclick="clearCompleted()" class="text-red-500 hover:text-red-600 font-medium text-xs sm:text-sm">
                Erledigte lÃ¶schen (${completedCount})
              </button>
            </div>
          ` : ''}
        `;
      }
    }

    function generateQR() {
      if (!myPeerId) {
        initPeer();
        setTimeout(generateQR, 1000);
        return;
      }
      
      becomeHost();
      
      const shareUrl = window.location.href.split('?')[0] + '?peer=' + myPeerId;
      
      const modal = document.getElementById('qrModal');
      const qrContainer = document.getElementById('qrcode');
      
      const encodedText = encodeURIComponent(shareUrl);
      const qrSize = 250;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodedText}`;
      
      qrContainer.innerHTML = `
        <img src="${qrUrl}" alt="QR Code" class="w-full h-auto rounded-lg" style="max-width: 250px;" />
        <div class="mt-3 p-2 bg-gray-100 rounded-lg">
          <p class="text-xs text-gray-600 text-center font-medium">Peer ID: ${myPeerId.substring(0, 8)}...</p>
        </div>
      `;
      
      modal.classList.remove('hidden');
    }

    function closeQRModal() {
      document.getElementById('qrModal').classList.add('hidden');
    }

    async function startScanner() {
      const modal = document.getElementById('scannerModal');
      const statusEl = document.getElementById('scannerStatus');
      modal.classList.remove('hidden');
      
      if (isScanning) return;
      
      try {
        statusEl.textContent = 'Initialisiere Kamera...';
        statusEl.className = 'text-sm text-gray-600 dark:text-gray-300 mb-3';
        
        html5QrCode = new Html5Qrcode("reader");
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        };
        
        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanFailure
        );
        
        isScanning = true;
        statusEl.textContent = 'Scanne QR-Code...';
        statusEl.className = 'text-sm text-green-600 dark:text-green-400 mb-3 font-medium';
      } catch (err) {
        console.error('Scanner-Fehler:', err);
        statusEl.textContent = `Fehler: ${err.message || 'Kamera-Zugriff verweigert'}`;
        statusEl.className = 'text-sm text-red-600 dark:text-red-400 mb-3';
      }
    }

    async function stopScanner() {
      if (html5QrCode && isScanning) {
        try {
          await html5QrCode.stop();
          html5QrCode.clear();
        } catch (err) {
          console.error('Fehler beim Stoppen:', err);
        }
      }
      isScanning = false;
      html5QrCode = null;
      document.getElementById('scannerModal').classList.add('hidden');
    }

    function onScanSuccess(decodedText) {
      stopScanner();
      
      try {
        const url = new URL(decodedText);
        const peerId = url.searchParams.get('peer');
        
        if (peerId) {
          connectToPeer(peerId);
          showNotification('âœ… Verbindung wird hergestellt...');
        } else {
          showNotification('âŒ UngÃ¼ltiger QR-Code');
        }
      } catch (e) {
        showNotification('âŒ UngÃ¼ltiger QR-Code');
      }
    }

    function onScanFailure(error) {
      // Ignoriere normale Scan-Fehler
    }

    function showNotification(text) {
      const notification = document.getElementById('scanNotification');
      const notificationText = document.getElementById('scanNotificationText');
      notificationText.textContent = text;
      notification.classList.remove('hidden');
      setTimeout(() => notification.classList.add('hidden'), 3000);
    }

    function leaveSharedList() {
      if (confirm('MÃ¶chtest du die Live-Verbindung trennen?')) {
        disconnectFromPeers();
        showNotification('ðŸ‘‹ Verbindung getrennt');
        renderList();
        updateSummary();
      }
    }

    function initApp() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2 sm:p-4">
          <div class="max-w-2xl mx-auto">
            <div id="saveNotification" class="hidden fixed top-2 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm">
              <span class="font-semibold">Gespeichert!</span>
            </div>

            <div id="scanNotification" class="hidden fixed top-2 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm">
              <span class="font-semibold" id="scanNotificationText">Info</span>
            </div>

            <div id="scannerModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" onclick="if(event.target===this) stopScanner()">
              <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full p-4">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">QR-Code scannen</h3>
                  <button onclick="stopScanner()" class="text-gray-400 hover:text-gray-600">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                </div>
                <p id="scannerStatus" class="text-sm text-gray-600 dark:text-gray-300 mb-3">
                  Kamera wird geladen...
                </p>
                <div id="reader" class="w-full bg-black rounded-xl"></div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 text-center">
                  Halte den QR-Code vor die Kamera
                </p>
              </div>
            </div>

            <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this) closeQRModal()">
              <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-sm w-full p-4">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Liste teilen</h3>
                  <button onclick="closeQRModal()" class="text-gray-400 hover:text-gray-600">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-300 mb-3">
                  ðŸ”„ <strong>Direktverbindung (P2P)</strong><br>
                  Andere Person scannt diesen Code â†’ Beide sehen Ã„nderungen sofort live!
                </p>
                <div class="flex justify-center bg-white p-3 rounded-xl">
                  <div id="qrcode"></div>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-t-2xl shadow-lg p-3 sm:p-5">
              <div class="flex items-start justify-between mb-3 gap-2">
                <div class="flex items-center gap-2 flex-1 min-w-0">
                  <div class="bg-indigo-500 p-2 rounded-xl text-white flex-shrink-0">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                    </svg>
                  </div>
                  <div class="min-w-0">
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800 truncate">Einkaufsliste</h1>
                    <p class="text-xs sm:text-sm text-gray-500" id="itemCount">0 von 0 erledigt</p>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <div id="syncIndicator"></div>
                  <button onclick="toggleDarkMode()" class="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600 dark:text-gray-300">
                      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                  </button>
                  <div class="text-right">
                    <div class="text-lg sm:text-xl font-bold text-indigo-600" id="totalPrice">â‚¬0.00</div>
                    <div id="remainingPrice"></div>
                  </div>
                </div>
              </div>

              <div class="pt-3 border-t border-gray-200">
                <div class="grid grid-cols-3 gap-2 mb-2">
                  <button onclick="generateQR()" disabled id="qrBtn"
                    class="bg-purple-500 hover:bg-purple-600 disabled:bg-gray-300 text-white px-2 py-2 rounded-lg font-semibold text-xs sm:text-sm flex items-center justify-center gap-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                      <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Teilen
                  </button>
                  <button onclick="startScanner()" id="scanBtn"
                    class="bg-green-500 hover:bg-green-600 text-white px-2 py-2 rounded-lg font-semibold text-xs sm:text-sm flex items-center justify-center gap-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                      <circle cx="12" cy="13" r="4"/>
                    </svg>
                    Scannen
                  </button>
                  <button onclick="leaveSharedList()" id="leaveBtn"
                    class="bg-red-500 hover:bg-red-600 text-white px-2 py-2 rounded-lg font-semibold text-xs sm:text-sm flex items-center justify-center gap-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                      <polyline points="16 17 21 12 16 7"/>
                      <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Trennen
                  </button>
                </div>
              </div>
            </div>

            <div class="bg-white shadow-lg p-3 border-t border-gray-100">
              <input type="text" id="itemInput" placeholder="Artikel..." 
                class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none text-sm sm:text-base mb-2">
              
              <div class="flex gap-2 mb-2 items-end">
                <div class="flex-1">
                  <label class="text-xs text-gray-500 mb-1 block">Anzahl</label>
                  <input type="number" id="quantityInput" value="1" step="0.1" min="0.1"
                    class="w-full px-2 py-1.5 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none text-sm">
                </div>
                <div class="flex-1">
                  <label class="text-xs text-gray-500 mb-1 block">Preis â‚¬</label>
                  <input type="number" id="priceInput" step="0.01" min="0" placeholder="0.00"
                    class="w-full px-2 py-1.5 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none text-sm">
                </div>
                <div id="liveResult"></div>
              </div>
              
              <button onclick="addItem()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                HinzufÃ¼gen
              </button>
            </div>

            <div class="bg-white rounded-b-2xl shadow-lg p-3" id="itemList"></div>
          </div>
        </div>
      `;

      const itemInput = document.getElementById('itemInput');
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');

      itemInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addItem();
      });

      quantityInput.addEventListener('input', updateLiveCalculation);
      priceInput.addEventListener('input', updateLiveCalculation);

      // URL-Parameter prÃ¼fen
      const urlParams = new URLSearchParams(window.location.search);
      const peerIdFromUrl = urlParams.get('peer');
      
      if (peerIdFromUrl) {
        initPeer();
        setTimeout(() => connectToPeer(peerIdFromUrl), 1000);
      } else {
        initPeer();
      }

      renderList();
      updateSummary();
      updateSyncStatus(false);
    }

    window.addItem = addItem;
    window.toggleItem = toggleItem;
    window.deleteItem = deleteItem;
    window.startEdit = startEdit;
    window.saveEdit = saveEdit;
    window.cancelEdit = cancelEdit;
    window.clearCompleted = clearCompleted;
    window.toggleDarkMode = toggleDarkMode;
    window.generateQR = generateQR;
    window.closeQRModal = closeQRModal;
    window.startScanner = startScanner;
    window.stopScanner = stopScanner;
    window.leaveSharedList = leaveSharedList;

    applyDarkMode();
    initApp();
  </script>

</body>
</html>
