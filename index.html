<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Einkaufsliste mit automatischer Preisberechnung">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Meine Einkaufsliste</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // State
    let items = [];

    // Beim Start laden
    const saved = localStorage.getItem('shoppingList');
    if (saved) {
      try {
        items = JSON.parse(saved);
      } catch (e) {
        console.error('Fehler beim Laden:', e);
      }
    }

    // Speichern
    function saveItems() {
      localStorage.setItem('shoppingList', JSON.stringify(items));
      showSaveNotification();
    }

    function showSaveNotification() {
      const notification = document.getElementById('saveNotification');
      if (notification) {
        notification.classList.remove('hidden');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 2000);
      }
    }

    // Berechnung
    function calculateTotal(quantity, unitPrice) {
      const qty = parseFloat(quantity) || 1;
      const price = parseFloat(unitPrice) || 0;
      return qty * price;
    }

    // Live-Berechnung Update
    function updateLiveCalculation() {
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');
      const resultDiv = document.getElementById('liveResult');
      
      if (quantityInput && priceInput && resultDiv) {
        const qty = quantityInput.value;
        const price = priceInput.value;
        const total = calculateTotal(qty, price);
        
        if (total > 0) {
          resultDiv.innerHTML = `
            <div class="bg-green-50 px-4 py-2 rounded-xl border-2 border-green-200">
              <div class="text-xs text-green-600 font-medium">Gesamt</div>
              <div class="text-lg font-bold text-green-700">‚Ç¨${total.toFixed(2)}</div>
            </div>
          `;
        } else {
          resultDiv.innerHTML = '';
        }
      }
    }

    // Artikel hinzuf√ºgen
    function addItem() {
      const itemInput = document.getElementById('itemInput');
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');
      
      const text = itemInput.value.trim();
      if (!text) return;
      
      const qty = parseFloat(quantityInput.value) || 1;
      const unitPrice = parseFloat(priceInput.value) || 0;
      const totalPrice = calculateTotal(qty, unitPrice);
      
      items.push({
        id: Date.now(),
        text: text,
        quantity: qty,
        unitPrice: unitPrice,
        totalPrice: totalPrice,
        completed: false
      });
      
      itemInput.value = '';
      quantityInput.value = '1';
      priceInput.value = '';
      
      saveItems();
      renderList();
      updateSummary();
      updateLiveCalculation();
    }

    // Artikel abhaken
    function toggleItem(id) {
      items = items.map(item => 
        item.id === id ? { ...item, completed: !item.completed } : item
      );
      saveItems();
      renderList();
      updateSummary();
    }

    // Artikel l√∂schen
    function deleteItem(id) {
      items = items.filter(item => item.id !== id);
      saveItems();
      renderList();
      updateSummary();
    }

    // Erledigte l√∂schen
    function clearCompleted() {
      items = items.filter(item => !item.completed);
      saveItems();
      renderList();
      updateSummary();
    }

    // Summary aktualisieren
    function updateSummary() {
      const completedCount = items.filter(item => item.completed).length;
      const totalCount = items.length;
      const totalPrice = items.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const completedPrice = items.filter(item => item.completed).reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const remainingPrice = totalPrice - completedPrice;

      const countEl = document.getElementById('itemCount');
      const totalPriceEl = document.getElementById('totalPrice');
      const remainingPriceEl = document.getElementById('remainingPrice');
      const shareBtn = document.getElementById('shareBtn');

      if (countEl) countEl.textContent = `${completedCount} von ${totalCount} erledigt`;
      if (totalPriceEl) totalPriceEl.textContent = `‚Ç¨${totalPrice.toFixed(2)}`;
      if (remainingPriceEl) {
        remainingPriceEl.innerHTML = completedPrice > 0 ? `<p class="text-sm text-gray-500">Noch: ‚Ç¨${remainingPrice.toFixed(2)}</p>` : '';
      }
      if (shareBtn) shareBtn.disabled = items.length === 0;
    }

    // Liste rendern
    function renderList() {
      const listContainer = document.getElementById('itemList');
      const completedCount = items.filter(item => item.completed).length;
      
      if (items.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center py-12">
            <div class="bg-gray-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400">
                <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
              </svg>
            </div>
            <p class="text-gray-500 text-lg">Deine Einkaufsliste ist leer</p>
          </div>
        `;
      } else {
        listContainer.innerHTML = `
          <div class="space-y-2 max-h-96 overflow-y-auto">
            ${items.map(item => `
              <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                <button onclick="toggleItem(${item.id})" 
                  class="w-6 h-6 rounded-lg border-2 flex items-center justify-center ${item.completed ? 'bg-green-500 border-green-500' : 'border-gray-300'}">
                  ${item.completed ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                </button>
                <div class="flex-1">
                  <span class="text-lg font-medium ${item.completed ? 'line-through text-gray-400' : 'text-gray-700'}">
                    ${item.text} ${item.quantity > 1 ? `<span class="text-sm text-gray-500">(${item.quantity}x)</span>` : ''}
                  </span>
                  ${item.unitPrice > 0 ? `
                    <div class="text-xs mt-1 ${item.completed ? 'text-gray-400' : 'text-gray-500'}">
                      ${item.quantity > 1 ? `${item.quantity}x √† ‚Ç¨${item.unitPrice.toFixed(2)}` : `St√ºckpreis: ‚Ç¨${item.unitPrice.toFixed(2)}`}
                    </div>
                  ` : ''}
                  ${item.totalPrice > 0 ? `
                    <div class="text-sm font-bold mt-1 ${item.completed ? 'text-gray-400' : 'text-indigo-600'}">
                      ‚Ç¨${item.totalPrice.toFixed(2)}
                    </div>
                  ` : ''}
                </div>
                <button onclick="deleteItem(${item.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-lg">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            `).join('')}
          </div>
          ${completedCount > 0 ? `
            <div class="mt-4 pt-4 border-t border-gray-200">
              <button onclick="clearCompleted()" class="text-red-500 hover:text-red-600 font-medium text-sm">
                Erledigte Artikel l√∂schen (${completedCount})
              </button>
            </div>
          ` : ''}
        `;
      }
    }

    // Liste teilen
    function shareList() {
      const listText = items
        .filter(item => !item.completed)
        .map(item => {
          let line = `‚Ä¢ ${item.text}`;
          if (item.quantity > 1) line += ` (${item.quantity}x)`;
          if (item.totalPrice > 0) line += ` - ‚Ç¨${item.totalPrice.toFixed(2)}`;
          return line;
        })
        .join('\n');
      
      const totalPrice = items.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
      const fullText = `üõí Einkaufsliste\n\n${listText}\n\nGesamt: ‚Ç¨${totalPrice.toFixed(2)}`;

      if (navigator.share) {
        navigator.share({ title: 'Meine Einkaufsliste', text: fullText })
          .catch(err => {
            if (err.name !== 'AbortError') copyToClipboard(fullText);
          });
      } else {
        copyToClipboard(fullText);
      }
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text)
          .then(() => alert('‚úÖ Liste in Zwischenablage kopiert!'))
          .catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        alert('‚úÖ Liste in Zwischenablage kopiert!');
      } catch (err) {
        alert('Liste:\n\n' + text);
      }
      document.body.removeChild(textArea);
    }

    // Initial render
    function initApp() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div class="max-w-2xl mx-auto">
            <div id="saveNotification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50">
              <span class="font-semibold">Automatisch gespeichert!</span>
            </div>

            <div class="bg-white rounded-t-3xl shadow-lg p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div class="bg-indigo-500 p-3 rounded-2xl text-white">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                    </svg>
                  </div>
                  <div>
                    <h1 class="text-3xl font-bold text-gray-800">Einkaufsliste</h1>
                    <p class="text-gray-500 text-sm" id="itemCount">0 von 0 erledigt</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-bold text-indigo-600" id="totalPrice">‚Ç¨0.00</div>
                  <div id="remainingPrice"></div>
                </div>
              </div>

              <div class="pt-4 border-t border-gray-200">
                <button id="shareBtn" onclick="shareList()" disabled
                  class="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white px-4 py-2 rounded-xl font-medium">
                  Liste teilen
                </button>
              </div>
            </div>

            <div class="bg-white shadow-lg p-4 border-t border-gray-100">
              <input type="text" id="itemInput" placeholder="Artikel..." 
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none text-lg mb-3">
              
              <div class="flex gap-2 mb-3 items-end">
                <div class="flex-1">
                  <label class="text-xs text-gray-500 mb-1 block">Anzahl</label>
                  <input type="number" id="quantityInput" value="1" step="0.1" min="0.1"
                    class="w-full px-3 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                </div>
                <div class="flex-1">
                  <label class="text-xs text-gray-500 mb-1 block">St√ºckpreis ‚Ç¨</label>
                  <input type="number" id="priceInput" step="0.01" min="0" placeholder="0.00"
                    class="w-full px-3 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                </div>
                <div id="liveResult"></div>
              </div>
              
              <button onclick="addItem()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold">
                Hinzuf√ºgen
              </button>
            </div>

            <div class="bg-white rounded-b-3xl shadow-lg p-4" id="itemList"></div>
          </div>
        </div>
      `;

      // Event Listeners
      const itemInput = document.getElementById('itemInput');
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');

      itemInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addItem();
      });

      quantityInput.addEventListener('input', updateLiveCalculation);
      priceInput.addEventListener('input', updateLiveCalculation);

      renderList();
      updateSummary();
    }

    // Funktionen global machen
    window.addItem = addItem;
    window.toggleItem = toggleItem;
    window.deleteItem = deleteItem;
    window.clearCompleted = clearCompleted;
    window.shareList = shareList;

    // App starten
    initApp();
  </script>

</body>
</html>
